{% extends "base.html" %}

{% block page_title %}Payments{% endblock %}

{% block content %}
<div class="p-6 md:p-10 max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-900">All Payments</h1>
        <button id="new-payment-btn" class="inline-flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            <span>Record Payment</span>
        </button>
    </div>

    <div class="card overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Contract</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Amount</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Paid At</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Method</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for p in payments %}
                    <tr class="hover:bg-gray-50 even:bg-gray-50">
                        <td class="p-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ p.id }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-blue-600 hover:text-blue-800">
                            <a href="/contracts/ui/{{ p.contract_id }}">#{{ p.contract_id }}</a>
                        </td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">${{ p.amount }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">{{ p.paid_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">{{ p.method or '-' }}</td>
                        <td class="p-4 whitespace-nowrap text-sm font-medium">
                            <button data-id="{{ p.id }}" class="delete-payment text-red-600 hover:text-red-800 transition-colors duration-200 focus:outline-none">Delete</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td class="p-4 text-gray-500" colspan="6">No payments found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Payment Modal -->
<div id="payment-form-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    <div class="relative p-8 border w-full max-w-md shadow-2xl rounded-3xl bg-white transform scale-95 transition-all duration-300">
        <div class="flex justify-between items-center pb-4 border-b border-gray-200">
            <h3 id="form-modal-title" class="text-xl font-semibold text-gray-800">Record New Payment</h3>
            <button id="form-modal-close" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form id="payment-form" class="mt-6 space-y-6">
            <div>
                <label for="contract_id" class="block text-sm font-medium text-gray-700">Contract ID</label>
                    <select name="contract_id" id="contract" class="w-full border p-2 rounded">
                        <option value="">Select contract</option>
                        {% for c in contracts %}
                        <option value="{{ c.id }}">#{{ c.id }} â€” Tenant: {{ c.tenant.name if c.tenant else c.tenant_id }}</option>
                        {% endfor %}
                      </select>
            </div>
            <div>
                <label for="amount" class="block text-sm font-medium text-gray-700">Amount</label>
                <input type="number" step="0.01" id="amount" name="amount" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div>
                <label for="method" class="block text-sm font-medium text-gray-700">Method</label>
                <input type="text" id="method" name="method" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div>
                <label for="note" class="block text-sm font-medium text-gray-700">Note</label>
                <textarea id="note" name="note" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
            </div>
            <div id="form-error-message" class="text-red-600 text-sm hidden"></div>
            <div class="flex justify-end pt-6 border-t border-gray-200">
                <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors duration-200 transform hover:scale-105">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    <div class="relative p-8 border w-96 shadow-2xl rounded-3xl bg-white transform scale-95 transition-all duration-300">
        <div class="mt-3 text-center">
            <h3 class="text-xl leading-6 font-semibold text-gray-900">Confirm Deletion</h3>
            <div class="mt-4">
                <p class="text-sm text-gray-500">Are you sure you want to delete this payment? This action cannot be undone.</p>
            </div>
            <div id="delete-modal-error" class="text-red-600 text-sm mt-2 hidden"></div>
            <div class="flex justify-end pt-6 border-t border-gray-200 mt-6">
                <button id="modal-delete-btn" class="px-5 py-2.5 bg-red-600 text-white text-base font-medium rounded-lg shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 mr-2 transform hover:scale-105">Delete</button>
                <button id="modal-cancel-btn" class="px-5 py-2.5 bg-gray-200 text-gray-800 text-base font-medium rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // New function to fetch the token from the server
    async function getAuthToken() {
        try {
            const response = await fetch('/auth/token-for-js');
            if (response.ok) {
                const data = await response.json();
                return data.token;
            } else {
                console.error('Failed to get token from server.');
                window.location.href = '/auth/login';
                return null;
            }
        } catch (error) {
            console.error('Network error fetching token:', error);
            window.location.href = '/auth/login';
            return null;
        }
    }

    // --- Modal elements ---
    const paymentFormModal = document.getElementById('payment-form-modal');
    const newPaymentBtn = document.getElementById('new-payment-btn');
    const formModalCloseBtn = document.getElementById('form-modal-close');
    const paymentForm = document.getElementById('payment-form');
    const formErrorMsg = document.getElementById('form-error-message');

    // --- Delete modal elements ---
    const deleteModal = document.getElementById('delete-modal');
    const modalDeleteBtn = document.getElementById('modal-delete-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const deletePaymentBtns = document.querySelectorAll('.delete-payment');
    const deleteModalError = document.getElementById('delete-modal-error');
    let paymentIdToDelete = null;

    // --- Form Modal Logic (Add) ---
    function openFormModal() {
        formErrorMsg.classList.add('hidden');
        paymentFormModal.classList.remove('opacity-0', 'pointer-events-none');
        paymentFormModal.querySelector('.relative').classList.remove('scale-95');
    }

    function closeFormModal() {
        paymentFormModal.classList.add('opacity-0', 'pointer-events-none');
        paymentFormModal.querySelector('.relative').classList.add('scale-95');
        paymentForm.reset();
    }

    newPaymentBtn.addEventListener('click', () => {
        openFormModal();
    });

    formModalCloseBtn.addEventListener('click', () => {
        closeFormModal();
    });
    
    paymentFormModal.addEventListener('click', (e) => {
        if (e.target.id === 'payment-form-modal') {
            closeFormModal();
        }
    });

    paymentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        formErrorMsg.classList.add('hidden');

        const token = await getAuthToken();
        if (!token) return;

        const formData = new FormData(paymentForm);
        const payload = {
            contract_id: parseInt(formData.get('contract_id')),
            amount: parseFloat(formData.get('amount')),
            method: formData.get('method') || null,
            note: formData.get('note') || null
        };

        try {
            const res = await fetch('/payments/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                location.reload();
            } else {
                const err = await res.json();
                formErrorMsg.textContent = err.detail || 'Failed to record payment.';
                formErrorMsg.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Network or server error:', error);
            formErrorMsg.textContent = 'A network error occurred. Please try again.';
            formErrorMsg.classList.remove('hidden');
        }
    });

    // --- Delete Modal Logic ---
    function openDeleteModal() {
        deleteModalError.classList.add('hidden');
        deleteModal.classList.remove('opacity-0', 'pointer-events-none');
        deleteModal.querySelector('.relative').classList.remove('scale-95');
    }

    function closeDeleteModal() {
        deleteModal.classList.add('opacity-0', 'pointer-events-none');
        deleteModal.querySelector('.relative').classList.add('scale-95');
        paymentIdToDelete = null;
    }

    deletePaymentBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            paymentIdToDelete = btn.dataset.id;
            openDeleteModal();
        });
    });

    modalCancelBtn.addEventListener('click', () => {
        closeDeleteModal();
    });

    deleteModal.addEventListener('click', (e) => {
        if (e.target.id === 'delete-modal') {
            closeDeleteModal();
        }
    });

    modalDeleteBtn.addEventListener('click', async () => {
        if (!paymentIdToDelete) return;
        
        deleteModalError.classList.add('hidden');

        const token = await getAuthToken();
        if (!token) return;

        try {
            const res = await fetch('/payments/' + paymentIdToDelete, { 
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (res.status === 204) {
                location.reload();
            } else {
                const err = await res.json();
                deleteModalError.textContent = 'Error: ' + (err.detail || 'Delete failed');
                deleteModalError.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Network or server error:', error);
            deleteModalError.textContent = 'A network error occurred. Please try again.';
            deleteModalError.classList.remove('hidden');
        }
    });
});
</script>
{% endblock %}
