{% extends "base.html" %}

{% block page_title %}Contracts{% endblock %}

{% block content %}
<div class="p-6 md:p-10 max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-900">All Contracts</h1>
        <button id="new-contract-btn" class="inline-flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            <span>New Contract</span>
        </button>
    </div>

    <div class="card overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tenant</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Room</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Start Date</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">End Date</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Rent</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Active</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for c in contracts %}
                    <tr class="hover:bg-gray-50 even:bg-gray-50">
                        <td class="p-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ c.id }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-blue-600 hover:text-blue-800">{{ c.tenant.name if c.tenant else c.tenant_id }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">{{ c.room.number if c.room else c.room_id }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">{{ c.start_date }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">{{ c.end_date or '-' }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">${{ c.rent_amount }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {{ 'bg-green-100 text-green-800' if c.active else 'bg-red-100 text-red-800' }}">
                                {{ 'Yes' if c.active else 'No' }}
                            </span>
                        </td>
                        <td class="p-4 whitespace-nowrap text-sm font-medium">
                            <button data-id="{{ c.id }}" class="edit-contract text-yellow-600 hover:text-yellow-800 transition-colors duration-200 mr-4">Edit</button>
                            <button data-id="{{ c.id }}" class="delete-contract text-red-600 hover:text-red-800 transition-colors duration-200 focus:outline-none">Delete</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td class="p-4 text-gray-500" colspan="8">No contracts found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Contract Modal -->
<div id="contract-form-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    <div class="relative p-8 border w-full max-w-lg shadow-2xl rounded-3xl bg-white transform scale-95 transition-all duration-300">
        <div class="flex justify-between items-center pb-4 border-b border-gray-200">
            <h3 id="form-modal-title" class="text-xl font-semibold text-gray-800">New Contract</h3>
            <button id="form-modal-close" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form id="contract-form" class="mt-6 space-y-6">
            <input type="hidden" id="form-contract-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="tenant_id" class="block text-sm font-medium text-gray-700">Tenant</label>
                    <select id="tenant_id" name="tenant_id" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                </div>
                <div>
                    <label for="room_id" class="block text-sm font-medium text-gray-700">Room</label>
                    <select id="room_id" name="room_id" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                </div>
                <div>
                    <label for="start_date" class="block text-sm font-medium text-gray-700">Start Date</label>
                    <input type="date" id="start_date" name="start_date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="end_date" class="block text-sm font-medium text-gray-700">End Date</label>
                    <input type="date" id="end_date" name="end_date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="rent_amount" class="block text-sm font-medium text-gray-700">Rent Amount</label>
                    <input type="number" id="rent_amount" name="rent_amount" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="active" name="active" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="active" class="ml-2 block text-sm font-medium text-gray-700">Is Active</label>
                </div>
            </div>
            <div id="form-error-message" class="text-red-600 text-sm hidden"></div>
            <div class="flex justify-end pt-6 border-t border-gray-200">
                <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors duration-200 transform hover:scale-105">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    <div class="relative p-8 border w-96 shadow-2xl rounded-3xl bg-white transform scale-95 transition-all duration-300">
        <div class="mt-3 text-center">
            <h3 class="text-xl leading-6 font-semibold text-gray-900">Confirm Deletion</h3>
            <div class="mt-4">
                <p class="text-sm text-gray-500">Are you sure you want to delete this contract? This action cannot be undone.</p>
            </div>
            <div id="delete-modal-error" class="text-red-600 text-sm mt-2 hidden"></div>
            <div class="flex justify-end pt-6 border-t border-gray-200 mt-6">
                <button id="modal-delete-btn" class="px-5 py-2.5 bg-red-600 text-white text-base font-medium rounded-lg shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 mr-2 transform hover:scale-105">Delete</button>
                <button id="modal-cancel-btn" class="px-5 py-2.5 bg-gray-200 text-gray-800 text-base font-medium rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Modal elements ---
    const contractFormModal = document.getElementById('contract-form-modal');
    const newContractBtn = document.getElementById('new-contract-btn');
    const editContractBtns = document.querySelectorAll('.edit-contract');
    const formModalCloseBtn = document.getElementById('form-modal-close');
    const contractForm = document.getElementById('contract-form');
    const formModalTitle = document.getElementById('form-modal-title');
    const formContractId = document.getElementById('form-contract-id');
    const formTenantId = document.getElementById('tenant_id');
    const formRoomId = document.getElementById('room_id');
    const formStartDate = document.getElementById('start_date');
    const formEndDate = document.getElementById('end_date');
    const formRentAmount = document.getElementById('rent_amount');
    const formActive = document.getElementById('active');
    const formErrorMsg = document.getElementById('form-error-message');

    // --- Delete modal elements ---
    const deleteModal = document.getElementById('delete-modal');
    const modalDeleteBtn = document.getElementById('modal-delete-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const deleteContractBtns = document.querySelectorAll('.delete-contract');
    const deleteModalError = document.getElementById('delete-modal-error');
    let contractToDeleteId = null;

    // --- Form Modal Logic (Add/Edit) ---
    function openFormModal(action, contractData = {}) {
        formErrorMsg.classList.add('hidden');
        contractFormModal.classList.remove('opacity-0', 'pointer-events-none');
        contractFormModal.querySelector('.relative').classList.remove('scale-95');

        if (action === 'create') {
            formModalTitle.textContent = 'New Contract';
            contractForm.reset();
            formContractId.value = '';
        } else if (action === 'edit') {
            formModalTitle.textContent = 'Edit Contract';
            formContractId.value = contractData.id;
            formTenantId.value = contractData.tenant_id;
            formRoomId.value = contractData.room_id;
            formStartDate.value = contractData.start_date;
            formEndDate.value = contractData.end_date;
            formRentAmount.value = contractData.rent_amount;
            formActive.checked = contractData.active;
        }
    }

    function closeFormModal() {
        contractFormModal.classList.add('opacity-0', 'pointer-events-none');
        contractFormModal.querySelector('.relative').classList.add('scale-95');
    }

    async function fetchContractData(id) {
        try {
            const res = await fetch(`/contracts/${id}`);
            if (!res.ok) throw new Error('Failed to fetch contract data');
            return await res.json();
        } catch (error) {
            console.error('Error fetching contract:', error);
            formErrorMsg.textContent = 'Failed to load contract data.';
            formErrorMsg.classList.remove('hidden');
            return null;
        }
    }
    
    // Fetch tenants and rooms for the select inputs
    async function fetchSelectOptions() {
        try {
            const [tenantsRes, roomsRes] = await Promise.all([
                fetch('/tenants'),
                fetch('/rooms')
            ]);
            
            const tenants = await tenantsRes.json();
            const rooms = await roomsRes.json();

            // Populate tenant select
            formTenantId.innerHTML = '<option value="" disabled selected>Select Tenant</option>';
            tenants.forEach(tenant => {
                const option = document.createElement('option');
                option.value = tenant.id;
                option.textContent = tenant.name;
                formTenantId.appendChild(option);
            });

            // Populate room select
            formRoomId.innerHTML = '<option value="" disabled selected>Select Room</option>';
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.id;
                option.textContent = room.number;
                formRoomId.appendChild(option);
            });
        } catch (error) {
            console.error('Failed to fetch select options:', error);
            formErrorMsg.textContent = 'Failed to load tenant and room data. Please try again.';
            formErrorMsg.classList.remove('hidden');
        }
    }

    newContractBtn.addEventListener('click', () => {
        openFormModal('create');
        fetchSelectOptions();
    });

    editContractBtns.forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            const contractData = await fetchContractData(id);
            if (contractData) {
                await fetchSelectOptions(); // Wait for options to load before setting value
                openFormModal('edit', contractData);
            }
        });
    });

    formModalCloseBtn.addEventListener('click', () => {
        closeFormModal();
    });
    
    contractFormModal.addEventListener('click', (e) => {
        if (e.target.id === 'contract-form-modal') {
            closeFormModal();
        }
    });

    contractForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        formErrorMsg.classList.add('hidden');

        const formData = new FormData(contractForm);
        const contractId = formContractId.value;
        const payload = {
            tenant_id: parseInt(formData.get('tenant_id')),
            room_id: parseInt(formData.get('room_id')),
            start_date: formData.get('start_date'),
            end_date: formData.get('end_date') || null,
            rent_amount: parseFloat(formData.get('rent_amount')),
            active: formData.get('active') === 'on' ? true : false
        };

        const isEditing = !!contractId;
        const method = isEditing ? 'PUT' : 'POST';
        const url = isEditing ? `/contracts/${contractId}` : '/contracts/';

        try {
            const res = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                location.reload();
            } else {
                const err = await res.json();
                formErrorMsg.textContent = err.detail || 'Failed to save contract.';
                formErrorMsg.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Network or server error:', error);
            formErrorMsg.textContent = 'A network error occurred. Please try again.';
            formErrorMsg.classList.remove('hidden');
        }
    });

    // --- Delete Modal Logic ---
    function openDeleteModal() {
        deleteModalError.classList.add('hidden');
        deleteModal.classList.remove('opacity-0', 'pointer-events-none');
        deleteModal.querySelector('.relative').classList.remove('scale-95');
    }

    function closeDeleteModal() {
        deleteModal.classList.add('opacity-0', 'pointer-events-none');
        deleteModal.querySelector('.relative').classList.add('scale-95');
        contractToDeleteId = null;
    }

    deleteContractBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            contractToDeleteId = btn.dataset.id;
            openDeleteModal();
        });
    });

    modalCancelBtn.addEventListener('click', () => {
        closeDeleteModal();
    });

    deleteModal.addEventListener('click', (e) => {
        if (e.target.id === 'delete-modal') {
            closeDeleteModal();
        }
    });

    modalDeleteBtn.addEventListener('click', async () => {
        if (!contractToDeleteId) return;
        
        deleteModalError.classList.add('hidden');

        try {
            const res = await fetch('/contracts/' + contractToDeleteId, { method: 'DELETE' });
            if (res.status === 204) {
                location.reload();
            } else {
                const err = await res.json();
                deleteModalError.textContent = 'Error: ' + (err.detail || 'Delete failed');
                deleteModalError.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Network or server error:', error);
            deleteModalError.textContent = 'A network error occurred. Please try again.';
            deleteModalError.classList.remove('hidden');
        }
    });
});
</script>
{% endblock %}
