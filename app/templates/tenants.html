{% extends "base.html" %}

{% block page_title %}Tenants{% endblock %}

{% block content %}
<div class="p-6 md:p-10 max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-900">All Tenants</h1>
        <button id="new-tenant-btn" class="inline-flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            <span>New Tenant</span>
        </button>
    </div>

    <div class="card overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Name</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Email</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Phone</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Created</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for t in tenants %}
                    <tr class="hover:bg-gray-50 even:bg-gray-50">
                        <td class="p-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ t.id }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-blue-600 hover:text-blue-800"><a href="/tenants/ui/{{ t.id }}">{{ t.name }}</a></td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">{{ t.email or '-' }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">{{ t.phone or '-' }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">{{ t.created_at }}</td>
                        <td class="p-4 whitespace-nowrap text-sm font-medium">
                            <button data-id="{{ t.id }}" class="edit-tenant text-yellow-600 hover:text-yellow-800 transition-colors duration-200 mr-4">Edit</button>
                            <button data-id="{{ t.id }}" class="delete-tenant text-red-600 hover:text-red-800 transition-colors duration-200 focus:outline-none">Delete</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td class="p-4 text-gray-500" colspan="6">No tenants found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Tenant Modal -->
<div id="tenant-form-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    <div class="relative p-8 border w-full max-w-md shadow-2xl rounded-3xl bg-white transform scale-95 transition-all duration-300">
        <div class="flex justify-between items-center pb-4 border-b border-gray-200">
            <h3 id="form-modal-title" class="text-xl font-semibold text-gray-800">New Tenant</h3>
            <button id="form-modal-close" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form id="tenant-form" class="mt-6 space-y-6">
            <input type="hidden" id="form-tenant-id">
            <div id="id-group">
                <label for="id" class="block text-sm font-medium text-gray-700">ID</label>
                <input type="text" id="id" name="id" readonly class="mt-1 block w-full rounded-lg border-gray-300 bg-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 cursor-not-allowed">
            </div>
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                <input type="text" id="name" name="name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="email" name="email" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
                <input type="tel" id="phone" name="phone" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div id="created-group">
                <label for="created" class="block text-sm font-medium text-gray-700">Created</label>
                <input type="text" id="created" name="created" readonly class="mt-1 block w-full rounded-lg border-gray-300 bg-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 cursor-not-allowed">
            </div>
            <div id="form-error-message" class="text-red-600 text-sm hidden"></div>
            <div class="flex justify-end pt-6 border-t border-gray-200">
                <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors duration-200 transform hover:scale-105">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    <div class="relative p-8 border w-96 shadow-2xl rounded-3xl bg-white transform scale-95 transition-all duration-300">
        <div class="mt-3 text-center">
            <h3 class="text-xl leading-6 font-semibold text-gray-900">Confirm Deletion</h3>
            <div class="mt-4">
                <p class="text-sm text-gray-500">Are you sure you want to delete this tenant? This action cannot be undone.</p>
            </div>
            <div id="delete-modal-error" class="text-red-600 text-sm mt-2 hidden"></div>
            <div class="flex justify-end pt-6 border-t border-gray-200 mt-6">
                <button id="modal-delete-btn" class="px-5 py-2.5 bg-red-600 text-white text-base font-medium rounded-lg shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 mr-2 transform hover:scale-105">Delete</button>
                <button id="modal-cancel-btn" class="px-5 py-2.5 bg-gray-200 text-gray-800 text-base font-medium rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Modal elements ---
    const tenantFormModal = document.getElementById('tenant-form-modal');
    const newTenantBtn = document.getElementById('new-tenant-btn');
    const editTenantBtns = document.querySelectorAll('.edit-tenant');
    const formModalCloseBtn = document.getElementById('form-modal-close');
    const tenantForm = document.getElementById('tenant-form');
    const formModalTitle = document.getElementById('form-modal-title');
    const formTenantId = document.getElementById('form-tenant-id');
    const formName = document.getElementById('name');
    const formEmail = document.getElementById('email');
    const formPhone = document.getElementById('phone');
    const formErrorMsg = document.getElementById('form-error-message');
    const idGroup = document.getElementById('id-group');
    const createdGroup = document.getElementById('created-group');
    const formId = document.getElementById('id');
    const formCreated = document.getElementById('created');


    // --- Delete modal elements ---
    const deleteModal = document.getElementById('delete-modal');
    const modalDeleteBtn = document.getElementById('modal-delete-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const deleteTenantBtns = document.querySelectorAll('.delete-tenant');
    const deleteModalError = document.getElementById('delete-modal-error');
    let tenantToDeleteId = null;

    // --- Form Modal Logic (Add/Edit) ---
    function openFormModal(action, tenantData = {}) {
        formErrorMsg.classList.add('hidden');
        tenantFormModal.classList.remove('opacity-0', 'pointer-events-none');
        tenantFormModal.querySelector('.relative').classList.remove('scale-95');

        // Always show all groups for visual consistency, but set values based on action
        idGroup.classList.remove('hidden');
        createdGroup.classList.remove('hidden');

        if (action === 'create') {
            formModalTitle.textContent = 'New Tenant';
            tenantForm.reset();
            formTenantId.value = '';
            // Set placeholders for new tenant
            formId.value = 'Auto-generated on save';
            formCreated.value = 'Not yet created';
        } else if (action === 'edit') {
            formModalTitle.textContent = 'Edit Tenant';
            formTenantId.value = tenantData.id;
            formName.value = tenantData.name;
            formEmail.value = tenantData.email;
            formPhone.value = tenantData.phone;
            formId.value = tenantData.id;
            formCreated.value = tenantData.created_at;
        }
    }

    function closeFormModal() {
        tenantFormModal.classList.add('opacity-0', 'pointer-events-none');
        tenantFormModal.querySelector('.relative').classList.add('scale-95');
    }

    async function fetchTenantData(id) {
        try {
            const res = await fetch(`/tenants/${id}`);
            if (!res.ok) throw new Error('Failed to fetch tenant data');
            return await res.json();
        } catch (error) {
            console.error('Error fetching tenant:', error);
            formErrorMsg.textContent = 'Failed to load tenant data.';
            formErrorMsg.classList.remove('hidden');
            return null;
        }
    }

    newTenantBtn.addEventListener('click', () => {
        openFormModal('create');
    });

    editTenantBtns.forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            const tenantData = await fetchTenantData(id);
            if (tenantData) {
                openFormModal('edit', tenantData);
            }
        });
    });

    formModalCloseBtn.addEventListener('click', () => {
        closeFormModal();
    });
    
    tenantFormModal.addEventListener('click', (e) => {
        if (e.target.id === 'tenant-form-modal') {
            closeFormModal();
        }
    });

    tenantForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        formErrorMsg.classList.add('hidden');

        const formData = new FormData(tenantForm);
        const tenantId = formTenantId.value;
        const payload = Object.fromEntries(formData.entries());

        const isEditing = !!tenantId;
        const method = isEditing ? 'PUT' : 'POST';
        const url = isEditing ? `/tenants/${tenantId}` : '/tenants/';

        try {
            const res = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                location.reload();
            } else {
                const err = await res.json();
                formErrorMsg.textContent = err.detail || 'Failed to save tenant.';
                formErrorMsg.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Network or server error:', error);
            formErrorMsg.textContent = 'A network error occurred. Please try again.';
            formErrorMsg.classList.remove('hidden');
        }
    });

    // --- Delete Modal Logic ---
    function openDeleteModal() {
        deleteModalError.classList.add('hidden');
        deleteModal.classList.remove('opacity-0', 'pointer-events-none');
        deleteModal.querySelector('.relative').classList.remove('scale-95');
    }

    function closeDeleteModal() {
        deleteModal.classList.add('opacity-0', 'pointer-events-none');
        deleteModal.querySelector('.relative').classList.add('scale-95');
        tenantToDeleteId = null;
    }

    deleteTenantBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            tenantToDeleteId = btn.dataset.id;
            openDeleteModal();
        });
    });

    modalCancelBtn.addEventListener('click', () => {
        closeDeleteModal();
    });

    deleteModal.addEventListener('click', (e) => {
        if (e.target.id === 'delete-modal') {
            closeDeleteModal();
        }
    });

    modalDeleteBtn.addEventListener('click', async () => {
        if (!tenantToDeleteId) return;
        
        deleteModalError.classList.add('hidden');

        try {
            const res = await fetch('/tenants/' + tenantToDeleteId, { method: 'DELETE' });
            if (res.status === 204) {
                location.reload();
            } else {
                const err = await res.json();
                deleteModalError.textContent = 'Error: ' + (err.detail || 'Delete failed');
                deleteModalError.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Network or server error:', error);
            deleteModalError.textContent = 'A network error occurred. Please try again.';
            deleteModalError.classList.remove('hidden');
        }
    });
});
</script>
{% endblock %}
